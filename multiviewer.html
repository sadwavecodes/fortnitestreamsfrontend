<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fortnite MultiViewer</title>
<link rel="stylesheet" href="styles.css" />
<style>
  /* Container that fixes 16:9 aspect ratio, fills viewport width */
  #multi-container {
    position: relative;
    width: 100vw;
    max-width: 1280px;
    /* 16:9 aspect ratio */
    aspect-ratio: 16 / 9;
    margin: 2rem auto;
    background: #121212;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 12px 30px rgba(79, 195, 247, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* The dynamic grid inside the 16:9 container */
  #streams-grid {
    width: 100%;
    height: 100%;
    display: grid;
    gap: 8px;
    /* grid-template-columns and rows set dynamically by JS */
  }

  /* Each iframe wrapper */
  .stream-item {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(79, 195, 247, 0.6);
  }

  .stream-item iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 10px;
    background: #000;
  }

  /* Metadata overlay on each stream */
  .stream-meta {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.85));
    color: #fff;
    padding: 6px 10px;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    justify-content: space-between;
    pointer-events: none;
  }

  /* Back button */
  #back-btn {
    position: fixed;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: #4fc3f7;
    border: none;
    color: #121212;
    font-weight: 700;
    font-size: 1rem;
    padding: 0.6rem 1.3rem;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 5px 15px #4fc3f7aa;
    transition: background-color 0.3s ease;
    z-index: 1000;
  }
  #back-btn:hover {
    background: #2ea0e0;
  }

  /* Responsive small screens */
  @media (max-width: 480px) {
    #multi-container {
      max-width: 100vw;
      aspect-ratio: unset;
      height: 56vw; /* approx 16:9 height */
      margin: 1rem 0;
    }
  }
</style>
</head>
<body>
  <button id="back-btn" aria-label="Back to Main Page">← Back</button>
  <main id="multi-container" aria-label="Multi Stream Viewer">
    <div id="streams-grid" role="list" aria-live="polite"></div>
  </main>

<script>
  // Parse selected streams from URL: ?stream=embedUrl1&stream=embedUrl2...
  const params = new URLSearchParams(window.location.search);
  const streams = params.getAll("stream");

  const grid = document.getElementById("streams-grid");
  const backBtn = document.getElementById("back-btn");

  backBtn.addEventListener("click", () => {
    window.history.back();
  });

  // Calculate best grid layout (cols x rows) to fit streams inside 16:9 container
  // Try to get as close as possible to 16:9 aspect ratio per stream
  function calculateGrid(n) {
    if (n === 0) return { cols: 1, rows: 1 };
    let bestCols = 1, bestRows = n;
    let bestDiff = Infinity;
    for (let cols = 1; cols <= n; cols++) {
      const rows = Math.ceil(n / cols);
      // Calculate aspect ratio of each cell (width / height)
      // Container ratio is 16/9, so each cell ratio should be close to that or better fit
      const cellRatio = (16 / 9) * (cols / rows);
      const diff = Math.abs(cellRatio - (16 / 9));
      if (diff < bestDiff) {
        bestDiff = diff;
        bestCols = cols;
        bestRows = rows;
      }
    }
    return { cols: bestCols, rows: bestRows };
  }

  // Set grid style dynamically
  function setGridLayout(n) {
    const { cols, rows } = calculateGrid(n);
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  }

  // Create stream iframe with metadata overlay
  function createStreamItem(url) {
    const div = document.createElement("div");
    div.className = "stream-item";

    const iframe = document.createElement("iframe");
    iframe.src = url;
    iframe.allow = "autoplay; fullscreen; picture-in-picture";
    iframe.allowFullscreen = true;
    iframe.loading = "lazy";
    div.appendChild(iframe);

    // Metadata (parse username/viewers from url query if passed)
    // We'll parse streamer name from URL param embedUrl channel param
    let streamerName = "Unknown Creator";
    let viewers = "?";

    try {
      const u = new URL(url);
      // For Twitch: channel param contains username
      const channel = u.searchParams.get("channel");
      if (channel) streamerName = channel;

      // For YouTube embed, get video id for display
      if (u.hostname.includes("youtube")) {
        const vid = u.pathname.split("/").pop();
        streamerName = "YouTube Live";
      }
    } catch {}

    const meta = document.createElement("div");
    meta.className = "stream-meta";
    meta.textContent = `${streamerName}  •  ${viewers} viewers`;

    div.appendChild(meta);
    return div;
  }

  if (streams.length === 0) {
    grid.innerHTML = "<p style='color:#bbb; font-size:1.2rem; text-align:center;'>No streams selected. Go back and select streams to watch.</p>";
  } else {
    setGridLayout(streams.length);
    streams.forEach((s) => {
      grid.appendChild(createStreamItem(s));
    });
  }
</script>
</body>
</html>
